{% extends "base.html" %}
{% block title %}Clientes - AdminProp{% endblock %}
{% block head %}{% endblock %}

{% block content %}
    <section id="clientes" class="page active">
        <h1>Clientes</h1>
        <table>
            <thead>
            <tr>
                <th>Nombre</th>
                <th>Dirección</th>
                <th>Alquiler <button title="Ordenar"><i class="fa-solid fa-arrow-down"></i></button></th>
                <th>Expensas <button title="Ordenar"><i class="fa-solid fa-arrow-down"></i></button></th>
                <th>Deuda <button title="Ordenar"><i class="fa-solid fa-arrow-down"></i></button></th>
                <th>Pago <button title="Ordenar"><i class="fa-solid fa-arrow-down"></i></button></th>
                <th>Pago al día</th>
            </tr>
            </thead>
                   <tbody>
                        {% for client in clients %}
                        <tr>
                            <td>{{ client.nombre }}</td>
                            <td>{{ client.direccion }}</td>

                            <td data-value="{{ client.alquiler or 0 }}">${{ "{:,.2f}".format(client.alquiler or 0) }}</td>
                            <td data-value="{{ client.expensas or 0 }}">${{ "{:,.2f}".format(client.expensas or 0) }}</td>
                            <td data-value="{{ client.deuda or 0 }}">${{ "{:,.2f}".format(client.deuda or 0) }}</td>
                            <td data-value="{{ client.pago or 0 }}">${{ "{:,.2f}".format(client.pago or 0) }}</td>

                            <td>
                                {% if client.pago_al_dia %}
                                    <span title="Al día">&#9989;</span>
                                {% else %}
                                    <span title="Posee deuda">&#10060;</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="8" style="text-align: center;">No se encontraron clientes.</td>
                        </tr>
                    {% endfor %}
                    </tbody>
        </table>
        <div class="container-caja">
            <div class="caja">
                <h1>Pagos adeudados</h1>
                <div>
                    <canvas id="deudaIngresosChart"></canvas>
                </div>
            </div>
            <div class="caja">
                <h1>Mapa propiedades</h1>
                <div id="map"></div>
            </div>
        </div>
    </section>
{% block scripts %}
<script>
// La bandera que nos asegura que este código se ejecute UNA SOLA VEZ.
if (!window.clientesPageInitialized) {

    // 1. DATOS DEL BACKEND
    const dashboardData = {{ dashboard_data | tojson | safe }};
    console.log("Inicializando página de clientes con datos:", dashboardData);

    // 2. LÓGICA PARA ORDENAR LA TABLA (CÓDIGO COMPLETO)
    const tableBody = document.querySelector('table tbody');
    const sortButtons = document.querySelectorAll('thead th button');
    sortButtons.forEach((button, index) => {
        button.addEventListener('click', () => {
            const rows = Array.from(tableBody.querySelectorAll('tr'));
            const currentOrder = button.dataset.order || 'desc';
            const newOrder = currentOrder === 'desc' ? 'asc' : 'desc';
            button.dataset.order = newOrder;

            const icon = button.querySelector('i');
            icon.classList.toggle('fa-arrow-down');
            icon.classList.toggle('fa-arrow-up');

            rows.sort((rowA, rowB) => {
                // El índice se ajusta para saltar las primeras 2 columnas no ordenables
                const cellA = rowA.children[index + 2];
                const cellB = rowB.children[index + 2];
                const valueA = parseFloat(cellA.dataset.value || 0);
                const valueB = parseFloat(cellB.dataset.value || 0);
                return newOrder === 'desc' ? valueB - valueA : valueA - valueB;
            });

            tableBody.innerHTML = '';
            rows.forEach(row => tableBody.appendChild(row));
        });
    });

    // 3. LÓGICA PARA EL GRÁFICO DE TORTA
    const ctx = document.getElementById('deudaIngresosChart');
    if (ctx) {
        const existingChart = Chart.getChart(ctx);
        if (existingChart) {
            existingChart.destroy();
        }

        const deudaTotal = parseFloat(dashboardData.deuda_total || 0);
        const ingresosTotales = parseFloat(dashboardData.ingresos || 0);
        const pagadoAlDia = ingresosTotales > deudaTotal ? ingresosTotales - deudaTotal : 0;

        if (deudaTotal > 0 || pagadoAlDia > 0) {
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Deuda Total', 'Pagado / Ingresos Restantes'],
                    datasets: [{
                        data: [deudaTotal, pagadoAlDia],
                        backgroundColor: ['rgba(255, 99, 132, 0.7)', 'rgba(75, 192, 192, 0.7)'],
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }
    }

    // 4. LÓGICA PARA EL MAPA
    if (dashboardData.direcciones && dashboardData.direcciones.length > 0) {
    const mapElement = document.getElementById('map');
    if (mapElement) {
        // Retrasamos la inicialización para asegurar que el CSS se haya aplicado
        setTimeout(function() {
            // Solo inicializa el mapa si no existe
            if (!mapElement._leaflet_id) {
                console.log("Inicializando mapa de Leaflet...");

                const map = L.map('map').setView([-34.6037, -58.3816], 12);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
                }).addTo(map);

                // !! ESTA ES LA LÍNEA CLAVE !!
                // Forzamos al mapa a recalcular su tamaño después de un breve instante.
                setTimeout(() => map.invalidateSize(), 100);

                dashboardData.direcciones.forEach(address => {
                    const apiUrl = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(address)}&format=json&limit=1`;
                    fetch(apiUrl)
                        .then(response => response.json())
                        .then(data => {
                            if (data && data.length > 0) {
                                const lat = data[0].lat;
                                const lon = data[0].lon;
                                L.marker([lat, lon]).addTo(map).bindPopup(`<b>${address}</b>`);
                            }
                        })
                        .catch(error => console.error('Error de geocodificación:', error));
                });
            }
        }, 50); // Pequeño retraso inicial
    }
}

    // Ponemos la bandera en true para que este bloque no se vuelva a ejecutar.
    window.clientesPageInitialized = true;
}
</script>
{% endblock %}
{% endblock %}